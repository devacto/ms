#!/bin/bash

set -euo pipefail

export CONFLUENT_HOME=/Users/victor/Downloads/from_desktop/drc-demo/confluent-5.3.0

echo "Starting Kafka cluster..."
docker-compose -f docker-compose.yml up -d

echo "Sleeping 1 minute to wait for Kafka cluster to be up..."
sleep 60

echo "Creating clickstream topic..."
${CONFLUENT_HOME}/bin/kafka-topics --zookeeper localhost:2181 --create --topic clickstream --replication-factor 1 --partitions 1 --config retention.ms=172800000

echo "Starting UDP to Kafka Bridge"
nohup java -Dbind.host=0.0.0.0 -Dbind.port=10514 -Dtopic=clickstream -Dkafka.metadata.broker.list=localhost:9092 -Dkafka.serializer.class=kafka.serializer.StringEncoder -Dkafka.compression.codec=1 -Dkafka.producer.type=async -jar kafka-bridge/udp-kafka-bridge-assembly-0.1.jar > bridge.out 2> bridge.err &

echo "Starting Data producer..."
nohup java -jar data-producer/udpclient-1.0-SNAPSHOT-jar-with-dependencies.jar data-producer/config.properties > producer.out 2> producer.err &

echo "Putting clickstream into KSQL schema..."
${CONFLUENT_HOME}/bin/ksql http://localhost:8088 <<EOF
run script './ksql/clickstream-schema.sql';
exit ;
EOF
